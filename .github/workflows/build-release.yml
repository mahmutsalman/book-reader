name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags (v1.0.0, v1.0.1, etc.)
  workflow_dispatch:  # Allow manual trigger from GitHub Actions tab
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0) - leave empty for auto-generated'
        required: false
        type: string
      prerelease:
        description: 'Create pre-release'
        required: true
        default: 'true'
        type: boolean

permissions:
  contents: write  # Required to create releases and upload assets

jobs:
  build:
    name: Build ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, windows-latest]

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: npm ci

      - name: Build Python server (macOS)
        if: runner.os == 'macOS'
        run: |
          cd src/python-server
          chmod +x build.sh
          echo "=== Starting Python server build ==="
          ./build.sh || {
            echo "❌ Build script failed with exit code $?"
            echo "=== Checking what was created ==="
            ls -la python-runtime/ 2>/dev/null || echo "python-runtime/ directory does not exist"
            exit 1
          }
          echo "=== Build script completed successfully ==="
          echo "=== Checking python-runtime directory ==="
          ls -la python-runtime/
          echo "=== Checking launcher script ==="
          ls -la launch-server.sh

      - name: Build Python server (Windows)
        if: runner.os == 'Windows'
        run: |
          cd src/python-server
          echo === Starting Windows Python server build ===
          call build.bat
          if %errorlevel% neq 0 (
            echo [ERROR] Build script failed with exit code %errorlevel%
            exit /b 1
          )
          echo === Build script completed successfully ===
          echo === Checking python-runtime directory ===
          dir python-runtime
          echo === Checking launcher script ===
          dir launch-server.bat
        shell: cmd

      - name: Verify Python server runtime (macOS)
        if: runner.os == 'macOS'
        run: |
          echo "=== Verifying embedded Python runtime ==="
          RUNTIME_DIR="src/python-server/python-runtime"
          LAUNCHER_SCRIPT="src/python-server/launch-server.sh"

          if [ -d "$RUNTIME_DIR" ]; then
            echo "✅ Python runtime directory found at $RUNTIME_DIR"
            ls -lh "$RUNTIME_DIR" | head -20
          else
            echo "❌ ERROR: Python runtime directory not found at $RUNTIME_DIR"
            exit 1
          fi

          if [ -f "$LAUNCHER_SCRIPT" ]; then
            echo "✅ Launcher script found at $LAUNCHER_SCRIPT"
            ls -lh "$LAUNCHER_SCRIPT"
          else
            echo "❌ ERROR: Launcher script not found at $LAUNCHER_SCRIPT"
            exit 1
          fi
        shell: bash

      - name: Verify Python server runtime (Windows)
        if: runner.os == 'Windows'
        run: |
          echo === Verifying embedded Python runtime ===
          set RUNTIME_DIR=src\python-server\python-runtime
          set LAUNCHER_SCRIPT=src\python-server\launch-server.bat

          if exist "%RUNTIME_DIR%" (
            echo [SUCCESS] Python runtime directory found at %RUNTIME_DIR%
            dir "%RUNTIME_DIR%"
          ) else (
            echo [ERROR] Python runtime directory not found at %RUNTIME_DIR%
            exit /b 1
          )

          if exist "%LAUNCHER_SCRIPT%" (
            echo [SUCCESS] Launcher script found at %LAUNCHER_SCRIPT%
            dir "%LAUNCHER_SCRIPT%"
          ) else (
            echo [ERROR] Launcher script not found at %LAUNCHER_SCRIPT%
            exit /b 1
          )
        shell: cmd

      - name: Build Electron app
        run: npm run make
        env:
          DEBUG: electron-forge:*

      - name: Debug output structure (Windows)
        if: runner.os == 'Windows'
        run: |
          echo "=== Full output directory structure ==="
          tree /F out || dir /S out
        shell: cmd

      - name: Debug output structure (macOS)
        if: runner.os == 'macOS'
        run: |
          echo "=== Full output directory structure ==="
          find out -type f -o -type d | head -n 50 || true
        shell: bash

      - name: Verify Python runtime in packaged app (macOS)
        if: runner.os == 'macOS'
        run: |
          echo "=== Verifying Python runtime in packaged app ==="
          # Find the app bundle
          APP_PATH=$(find out -name "*.app" -type d | head -n 1 || true)
          if [ -z "$APP_PATH" ]; then
            echo "⚠️  Warning: Could not find .app bundle to verify"
            exit 0
          fi
          echo "Found app at: $APP_PATH"
          RESOURCES_PATH="$APP_PATH/Contents/Resources"
          RUNTIME_PATH="$RESOURCES_PATH/python-runtime"
          LAUNCHER_PATH="$RESOURCES_PATH/launch-server.sh"

          if [ -d "$RUNTIME_PATH" ]; then
            echo "✅ Python runtime successfully packaged at $RUNTIME_PATH"
            ls -lh "$RUNTIME_PATH" | head -10
          else
            echo "❌ ERROR: Python runtime NOT found in packaged app at $RUNTIME_PATH"
            echo "Resources directory contents:"
            ls -la "$RESOURCES_PATH" || echo "Resources directory not found"
            exit 1
          fi

          if [ -f "$LAUNCHER_PATH" ]; then
            echo "✅ Launcher script successfully packaged at $LAUNCHER_PATH"
            ls -lh "$LAUNCHER_PATH"
          else
            echo "❌ ERROR: Launcher script NOT found at $LAUNCHER_PATH"
            exit 1
          fi
        shell: bash

      - name: Verify Python runtime in packaged app (Windows)
        if: runner.os == 'Windows'
        run: |
          echo === Verifying Python runtime in packaged app ===
          set RESOURCES_PATH=out\Smart Book-win32-x64\resources
          set RUNTIME_PATH=%RESOURCES_PATH%\python-runtime
          set LAUNCHER_PATH=%RESOURCES_PATH%\launch-server.bat
          set SERVER_PATH=%RESOURCES_PATH%\server.py
          set GENERATORS_PATH=%RESOURCES_PATH%\generators

          if exist "%RUNTIME_PATH%" (
            echo [SUCCESS] Python runtime successfully packaged at %RUNTIME_PATH%
            dir "%RUNTIME_PATH%"
          ) else (
            echo [ERROR] Python runtime NOT found at %RUNTIME_PATH%
            if exist "%RESOURCES_PATH%" (
              echo Resources directory contents:
              dir "%RESOURCES_PATH%"
            ) else (
              echo Resources directory not found
            )
            exit /b 1
          )

          if exist "%LAUNCHER_PATH%" (
            echo [SUCCESS] Launcher script successfully packaged at %LAUNCHER_PATH%
            dir "%LAUNCHER_PATH%"
          ) else (
            echo [ERROR] Launcher script NOT found at %LAUNCHER_PATH%
            exit /b 1
          )

          if exist "%SERVER_PATH%" (
            echo [SUCCESS] Server script successfully packaged at %SERVER_PATH%
          ) else (
            echo [ERROR] Server script NOT found at %SERVER_PATH%
            exit /b 1
          )

          if exist "%GENERATORS_PATH%" (
            echo [SUCCESS] Generators directory successfully packaged at %GENERATORS_PATH%
            dir "%GENERATORS_PATH%"
          ) else (
            echo [ERROR] Generators directory NOT found at %GENERATORS_PATH%
            echo This will cause ModuleNotFoundError: No module named 'generators'
            exit /b 1
          )

          if exist "%GENERATORS_PATH%\__init__.py" (
            echo [SUCCESS] generators/__init__.py found
          ) else (
            echo [ERROR] generators/__init__.py NOT found - package may not be importable
            exit /b 1
          )

          if exist "%GENERATORS_PATH%\tts.py" (
            echo [SUCCESS] generators/tts.py found
          ) else (
            echo [ERROR] generators/tts.py NOT found
            exit /b 1
          )
        shell: cmd

      - name: List build outputs (macOS)
        if: runner.os == 'macOS'
        run: |
          echo "=== Build outputs ==="
          find out/make -type f -name "*.dmg" -o -name "*.zip"
        shell: bash

      - name: List build outputs (Windows)
        if: runner.os == 'Windows'
        run: |
          echo "=== Build outputs ==="
          dir out\make\zip\win32\x64\*.zip
        shell: cmd

      - name: Upload artifacts (macOS)
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: |
            out/make/**/*.dmg
            out/make/**/*.zip
          retention-days: 30

      - name: Upload artifacts (Windows)
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: |
            out/make/zip/win32/x64/*.zip
          retention-days: 30

  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set version tag
        id: set_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ -n "${{ github.event.inputs.version }}" ]; then
              VERSION="${{ github.event.inputs.version }}"
            else
              # Generate version from timestamp
              VERSION="v$(date +'%Y.%m.%d')-build.${{ github.run_number }}"
            fi
            echo "Creating tag $VERSION"
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag -a "$VERSION" -m "Auto-generated release $VERSION"
            git push origin "$VERSION"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          else
            echo "version=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-build
          path: ./artifacts/macos

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-build
          path: ./artifacts/windows

      - name: Display artifact structure
        run: |
          echo "=== Artifact structure ==="
          ls -R ./artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.set_version.outputs.version }}
          files: |
            ./artifacts/macos/**/*.dmg
            ./artifacts/macos/**/*.zip
            ./artifacts/windows/**/*.zip
          prerelease: ${{ github.event.inputs.prerelease == 'true' || contains(steps.set_version.outputs.version, 'beta') || contains(steps.set_version.outputs.version, 'alpha') }}
          generate_release_notes: true
          draft: false
          name: Release ${{ steps.set_version.outputs.version }}
          body: |
            ## Smart Book Reader ${{ steps.set_version.outputs.version }}

            ### Downloads
            - **Windows**:
              - `.zip` portable - extract and run
            - **macOS**:
              - `.dmg` file - drag to Applications
              - `.zip` portable - extract and run

            ### Windows Installation
            **Note**: Smart Book is not signed with a Windows code signing certificate.

            1. Download `Smart.Book-win32-x64-*.zip`
            2. Extract to a folder (e.g., `C:\Apps\SmartBook\`)
            3. Right-click `Smart Book.exe` → Properties
            4. Check "Unblock" → Apply
            5. Run `Smart Book.exe`

            **If Windows SmartScreen appears:**
            - Click "More info"
            - Click "Run anyway"

            **Why?** Code signing certificates cost $300-500/year. The portable ZIP
            approach is free and works perfectly - just needs one-time security approval.

            ### macOS Installation
            - Open the DMG and drag to Applications folder

            ### What's New
            See release notes below for details.

            ---
            **Note**: First-time installation may take a few moments as dependencies are set up.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy-to-vps:
    name: Deploy to VPS
    needs: release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-build
          path: ./artifacts/macos

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-build
          path: ./artifacts/windows

      - name: Display artifact structure
        run: |
          echo "=== Downloaded artifacts ==="
          find ./artifacts -type f | head -50

      - name: Generate update manifest
        run: |
          node scripts/generate-update-manifest.js --artifacts-dir ./artifacts
          echo "=== Generated manifest ==="
          cat ./artifacts/latest.json

      - name: Setup SSH key
        env:
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$VPS_SSH_KEY" > ~/.ssh/vps_key
          chmod 600 ~/.ssh/vps_key
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null
          if [ ! -s ~/.ssh/known_hosts ]; then
            echo "Failed to get SSH host key"
            exit 1
          fi

      - name: Deploy to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PATH: ${{ secrets.VPS_PATH }}
        run: |
          # Create release directories on VPS
          ssh -i ~/.ssh/vps_key ${VPS_USER}@${VPS_HOST} "
            mkdir -p ${VPS_PATH}/windows ${VPS_PATH}/macos ${VPS_PATH}/release-notes
          "

          # Upload Windows artifacts (handle filenames with spaces)
          WINDOWS_COUNT=$(find ./artifacts/windows -name "*.zip" -type f 2>/dev/null | wc -l)
          if [ "$WINDOWS_COUNT" -gt 0 ]; then
            echo "Found $WINDOWS_COUNT Windows artifact(s)"
            find ./artifacts/windows -name "*.zip" -type f -print0 | while IFS= read -r -d '' file; do
              echo "Uploading: $file"
              rsync -avz --progress -e "ssh -i ~/.ssh/vps_key" "$file" ${VPS_USER}@${VPS_HOST}:${VPS_PATH}/windows/
            done
          else
            echo "Warning: No Windows .zip artifacts found"
          fi

          # Upload macOS artifacts (handle filenames with spaces)
          MACOS_COUNT=$(find ./artifacts/macos -type f \( -name "*.zip" -o -name "*.dmg" \) 2>/dev/null | wc -l)
          if [ "$MACOS_COUNT" -gt 0 ]; then
            echo "Found $MACOS_COUNT macOS artifact(s)"
            find ./artifacts/macos -type f \( -name "*.zip" -o -name "*.dmg" \) -print0 | while IFS= read -r -d '' file; do
              echo "Uploading: $file"
              rsync -avz --progress -e "ssh -i ~/.ssh/vps_key" "$file" ${VPS_USER}@${VPS_HOST}:${VPS_PATH}/macos/
            done
          else
            echo "Warning: No macOS artifacts found"
          fi

          # Upload manifest (required)
          if [ ! -f "./artifacts/latest.json" ]; then
            echo "Error: latest.json manifest not found"
            exit 1
          fi
          rsync -avz --progress -e "ssh -i ~/.ssh/vps_key" \
            ./artifacts/latest.json \
            ${VPS_USER}@${VPS_HOST}:${VPS_PATH}/

          echo "=== Deployment complete ==="
          echo "Manifest URL: https://smartbook.mahmutsalman.cloud/releases/latest.json"

      - name: Verify deployment
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PATH: ${{ secrets.VPS_PATH }}
        run: |
          echo "=== Verifying deployment ==="
          ssh -i ~/.ssh/vps_key ${VPS_USER}@${VPS_HOST} "
            echo 'Files in releases directory:'
            ls -la ${VPS_PATH}/
            echo ''
            echo 'Windows artifacts:'
            ls -la ${VPS_PATH}/windows/ || echo 'No Windows artifacts'
            echo ''
            echo 'macOS artifacts:'
            ls -la ${VPS_PATH}/macos/ || echo 'No macOS artifacts'
            echo ''
            echo 'Manifest content:'
            cat ${VPS_PATH}/latest.json
          "
